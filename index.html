<html>
    <head> 
        <script src="{{ jq }}"></script>
		<script type="text/javascript">
		$(document).ready(function(){
			window.setInterval(getData, 1000);
		});

        function add_to_log(name, log) {
                $(name).empty();
                var len = log.length;
                for (var i = 0; i < len; i++) {
                    entry = log[i];
                    if (entry["isReceiving"]) {
                        $(name).append(
                            $('<li>').append(
                                "[" + entry["timestamp"] +"]" +
                                " Received " + entry["ciphertext"] +
                                " decrypted as " + entry["plaintext"] +
                                " with key stream " + entry["keystream"]
                        ));
                    } else {
                        $(name).append(
                            $('<li>').append(
                                "[" + entry["timestamp"] +"]" +
                                " Sent " + entry["plaintext"] +
                                " encrypted as " + entry["ciphertext"] +
                                " with key stream " + entry["keystream"] 
                        ));
                   }
                }
        }

        function add_to_chat(dev_1_name, dev_2_name, log) {
                $(dev_1_name).empty();
                $(dev_2_name).empty();
                var len = log.length;
                for (var i = 0; i < len; i++) {
                    entry = log[i];
                    if (entry["isReceiving"]) {
                        $(dev_1_name).append(
                            $('<li>').append(
                                "Him: " + entry["plaintext"] 
                        ));
                        $(dev_2_name).append(
                            $('<li>').append(
                                "Me: " + entry["plaintext"] 
                        ));
                    } else {
                        $(dev_1_name).append(
                            $('<li>').append(
                                "Me: " + entry["plaintext"] 
                        ));
                        $(dev_2_name).append(
                            $('<li>').append(
                                "Him: " + entry["plaintext"] 
                        ));
                   }
                }
        }

		function getData(){
			$.getJSON("http://localhost:8000/data?callback=?", function(data){
				$("#Kc_master").text(data.kcmaster);
				$("#ADDR_master").text(data.admaster);
				$("#CLK_master").text(data.clmaster);
				$("#PT_master").text(data.ptmaster);
				$("#KS_master").text(data.ksmaster);
				$("#CT_master").text(data.ctmaster);
				$("#Kc_slave").text(data.kcslave);
				$("#PT_slave").text(data.ptslave);
				$("#KS_slave").text(data.ksslave);
				$("#CT_slave").text(data.ctslave);

                add_to_log('#master_log', data.logs["device_1"]);
                add_to_log('#slave_log', data.logs["device_2"]);

                add_to_chat('#master_chat', '#slave_chat', data.logs["device_1"]);
			});
		}
		</script>
	</head>
	<body>
        <h1>E0 Sate Monitor</h1>
		<form action="setAddress" method="get">
            Device 1 URL: 
                <input type="text" name="d1url" value="{{ masterUrl }}" />
                <br />    
            Device 2 URL: 
                <input type="text" name="d2url" value="{{ slaveUrl }}" />
                <br />
		    <input type="submit" value="set">
		</form>
		<br>
		<form name="KcForm" action="sendkc" method="get">
            Device 1 Kc: 
            <input id="Kc1_in" type="text" size="33" name="d1kc" value="{{ KCMaster }}"
                onkeyup="$('#Kc1_len').text(this.value.length);" />
            <span id="Kc1_len">{{Kc1_len}}</span> chars<br>
            Device 2 Kc: 
            <input id="Kc2_in" type="text" size="33" name="d2kc" value="{{ KCSlave }}"
                onkeyup="$('#Kc2_len').text(this.value.length);" />
            <span id="Kc2_len">{{Kc2_len}}</span> chars<br>
		    <input type="submit" value="send">
		</form>
        
        <hr />
        
        <div id="chat_master"> 
            <h2>Master Chat</h2>
            <ul id="master_chat"></ul>
        </div>

        <form action="sendPT" method="get">
		    Device 1 plaintext: <input type="text" name="pt"><br>
		    <input type="hidden" name="sendee" value="master">
		    <input type="submit" value="send">
		</form>
        
        <div id="chat_slave"> 
            <h2>Slave Chat</h2>
            <ul id="slave_chat"></ul>
        </div>
        
        <form action="sendPT" method="get">
		    Device 2 plaintext: <input type="text" name="pt"><br>
		    <input type="hidden" name="sendee" value="slave">
		    <input type="submit" value="send">
		</form>

        <hr />
            
        <div id="log_master"> 
            <h2>Master Log</h2>
            <ul id="master_log"></ul>
        </div>

        <div id="log_slave"> 
            <h2>Slave Log</h2>
            <ul id="slave_log"></ul>
        </div>

		<hr />
        
		<div id="master">
            <p>Master Kc: <span id="Kc_master" /> </p>
            <p>Master BD_ADDR: <span id="ADDR_master" /></p>
            <p>Master CLK26: <span id="CLK_master" /></p>
            <br />
            <p>Master Plain Text: <span id="PT_master" /></p>
            <p>Master Key Stream: <span id="KS_master" /></p>
            <p>Master Cipher Text: <span id="CT_master" /></p>
        </div>
        <br />
		<div id="slave">
            <p>Slave Kc: <span id="Kc_slave" /></p>
            <p>Slave Plain Text: <span id="PT_slave" /></p>
            <p>Slave Key Stream: <span id="KS_slave" /></p>
            <p>Slave Cipher Text: <span id="CT_slave" /></p>
        </div>
    </body>
</html>
